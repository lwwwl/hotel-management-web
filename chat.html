
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 页面编号: D-01 /ops/chatwoot-agent -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客服座席工作台 - 酒店SaaS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <style>
        :root {
            --primary: #0F62FE;
            --secondary: #FF6B00;
            --bg: #F5F7FA;
        }
        .chat-scroll {
            scrollbar-width: thin;
            scrollbar-color: #CBD5E1 #F1F5F9;
        }
        .chat-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .chat-scroll::-webkit-scrollbar-track {
            background: #F1F5F9;
        }
        .chat-scroll::-webkit-scrollbar-thumb {
            background: #CBD5E1;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-gray-50 font-[system-ui]" x-data="agentWorkspace()">
    <!-- 顶部导航 -->
    <div class="bg-gray-800 text-white">
        <div class="px-6 py-2 flex items-center justify-between">
            <div class="flex items-center space-x-6">
                <h1 class="text-lg font-semibold">客服工作台</h1>
                <nav class="flex space-x-4">
                    <a href="D-01-chatwoot-agent.html" class="px-3 py-1 bg-gray-700 rounded text-sm">会话管理</a>
                    <a href="D-02-kanboard.html" class="px-3 py-1 hover:bg-gray-700 rounded text-sm">工单系统</a>
                </nav>
            </div>
            <div class="text-sm">
                客服: 张三 | <a href="#" class="hover:underline">退出</a>
            </div>
        </div>
    </div>
    
    <div class="min-h-screen flex">
        <!-- 左侧边栏 - 会话列表 -->
        <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">客服工作台</h2>
                    <div class="flex items-center space-x-2">
                        <span class="inline-block w-2 h-2 bg-green-500 rounded-full"></span>
                        <span class="text-sm text-gray-600">在线</span>
                    </div>
                </div>
                
                <div class="relative">
                    <input 
                        type="text" 
                        placeholder="搜索房号或客人姓名..."
                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        x-model="searchQuery"
                    >
                    <svg class="absolute left-3 top-2.5 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>

            <!-- 会话队列标签 -->
            <div class="border-b border-gray-200">
                <div class="flex">
                    <button 
                        class="flex-1 px-4 py-3 text-sm font-medium text-center border-b-2 transition-colors"
                        :class="activeQueue === 'verified' ? 'border-blue-600 text-blue-600 bg-blue-50' : 'border-transparent text-gray-600 hover:text-gray-800'"
                        @click="activeQueue = 'verified'"
                    >
                        已验证队列
                        <span class="ml-1 px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full" x-text="getQueueCount('verified')"></span>
                    </button>
                    <button 
                        class="flex-1 px-4 py-3 text-sm font-medium text-center border-b-2 transition-colors"
                        :class="activeQueue === 'unverified' ? 'border-red-600 text-red-600 bg-red-50' : 'border-transparent text-gray-600 hover:text-gray-800'"
                        @click="activeQueue = 'unverified'"
                    >
                        待验证队列
                        <span class="ml-1 px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full" x-text="getQueueCount('unverified')"></span>
                    </button>
                </div>
            </div>

            <div class="p-4 border-b border-gray-200">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" x-text="stats.activeChats"></div>
                        <div class="text-gray-600">活跃会话</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" x-text="stats.resolvedToday"></div>
                        <div class="text-gray-600">今日解决</div>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto chat-scroll">
                <!-- 调试信息 -->
                <div class="p-2 bg-blue-50 border-b text-xs text-blue-800">
                    <div class="flex justify-between items-center">
                        <div>
                            总会话: <span x-text="chats.length"></span> | 
                            已验证: <span x-text="getQueueCount('verified')"></span> | 
                            未验证: <span x-text="getQueueCount('unverified')"></span> | 
                            当前队列: <span x-text="activeQueue"></span>
                        </div>
                        <button @click="console.log('会话数据:', chats)" class="px-2 py-1 bg-blue-600 text-white rounded text-xs">
                            控制台输出数据
                        </button>
                    </div>
                </div>

                <!-- 简化的会话列表 -->
                <div x-show="activeQueue === 'verified'">
                    <div class="p-2 bg-green-50 text-green-800 text-sm">已验证会话列表</div>
                    <template x-for="chat in chats.filter(c => c.verified === true)" :key="chat.id">
                        <div class="p-3 border-b bg-white hover:bg-gray-50 cursor-pointer" @click="selectChat(chat)">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-medium">
                                        房间 <span x-text="chat.roomNumber"></span> - <span x-text="chat.guestName"></span>
                                    </div>
                                    <div class="text-sm text-gray-600" x-text="chat.lastMessage"></div>
                                    <div class="text-xs text-gray-400" x-text="chat.lastTime"></div>
                                </div>
                                <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">已验证</span>
                            </div>
                        </div>
                    </template>
                </div>

                <div x-show="activeQueue === 'unverified'">
                    <div class="p-2 bg-red-50 text-red-800 text-sm">未验证会话列表</div>
                    <template x-for="chat in chats.filter(c => c.verified === false)" :key="chat.id">
                        <div class="p-3 border-b bg-white hover:bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div class="flex-1" @click="selectChat(chat)">
                                    <div class="font-medium">
                                        房间 <span x-text="chat.roomNumber"></span> - <span x-text="chat.guestName"></span>
                                    </div>
                                    <div class="text-sm text-gray-600" x-text="chat.lastMessage"></div>
                                    <div class="text-xs text-gray-400" x-text="chat.lastTime"></div>
                                </div>
                                <div class="flex flex-col space-y-1">
                                    <span class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded">待验证</span>
                                    <button 
                                        @click="quickVerify(chat)"
                                        class="px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700"
                                    >
                                        快速验证
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- 空状态 -->
                <div x-show="chats.filter(c => activeQueue === 'verified' ? c.verified === true : c.verified === false).length === 0" 
                     class="p-8 text-center text-gray-500">
                    <p>暂无会话</p>
                </div>

                <!-- Alpine.js加载检查 -->
                <div id="alpine-check" class="p-4 bg-red-50 border border-red-200 rounded-lg m-4">
                    <p class="text-red-800">正在加载客服工作台...</p>
                    <p class="text-sm text-red-600 mt-2">如果此消息持续显示，请刷新页面或检查网络连接。</p>
                </div>
            </div>
        </div>

        <!-- 主要内容区域 -->
        <div class="flex-1 flex flex-col">
            <div class="bg-white border-b border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <template x-if="selectedChat">
                            <div class="flex items-center space-x-4">
                                <div>
                                    <h3 class="font-medium text-gray-800">
                                        房间 <span x-text="selectedChat.roomNumber"></span> - <span x-text="selectedChat.guestName"></span>
                                    </h3>
                                    <p class="text-sm text-gray-600">
                                        入住时间: <span x-text="selectedChat.checkInDate"></span>
                                    </p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span 
                                        class="px-3 py-1 text-sm rounded-full"
                                        :class="selectedChat.verified ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                        x-text="selectedChat.verified ? '已验证' : '未验证'"
                                    ></span>
                                    <button 
                                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                        @click="showGuestInfo = true"
                                        data-testid="guest-info-btn"
                                    >
                                        客人信息
                                    </button>
                                </div>
                            </div>
                        </template>
                        <template x-if="!selectedChat">
                            <div class="text-gray-600">请选择一个会话</div>
                        </template>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button 
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center space-x-2"
                            @click="showCreateTaskModal = true"
                            :disabled="!selectedChat"
                            data-testid="create-task-btn"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>生成工单</span>
                        </button>
                        <button 
                            class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700"
                            @click="transferChat"
                            :disabled="!selectedChat"
                            data-testid="transfer-btn"
                        >
                            转接
                        </button>
                        <button 
                            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                            @click="resolveChat"
                            :disabled="!selectedChat"
                            data-testid="resolve-btn"
                        >
                            解决
                        </button>
                    </div>
                </div>
            </div>

            <!-- 聊天区域 -->
            <div class="flex-1 bg-gray-50 p-4">
                <template x-if="selectedChat">
                    <div class="h-full flex flex-col">
                        <div class="flex-1 bg-white rounded-lg shadow-sm overflow-y-auto chat-scroll p-4" id="messages-container">
                            <template x-for="message in selectedChat.messages" :key="message.id">
                                <div 
                                    class="mb-4"
                                    :class="message.sender === 'guest' ? 'text-left' : 'text-right'"
                                >
                                    <div 
                                        class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg"
                                        :class="message.sender === 'guest' ? 'bg-gray-100 text-gray-800' : 'bg-blue-600 text-white'"
                                    >
                                        <div x-text="message.content"></div>
                                        <div class="text-xs mt-1 opacity-75" x-text="message.timestamp"></div>
                                        <div x-show="message.translation" class="text-xs mt-1 opacity-75 italic">
                                            <span class="text-yellow-300">翻译:</span> <span x-text="message.translation"></span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div class="mt-4 bg-white rounded-lg shadow-sm p-4">
                            <div class="flex items-end space-x-4">
                                <div class="flex-1">
                                    <textarea 
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                        placeholder="输入消息..."
                                        rows="2"
                                        x-model="newMessage"
                                        @keydown.enter="sendMessage"
                                        data-testid="message-input"
                                    ></textarea>
                                </div>
                                <button 
                                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center space-x-2"
                                    @click="sendMessage"
                                    data-testid="send-btn"
                                >
                                    <span>发送</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <div class="mt-3 flex flex-wrap gap-2">
                                <template x-for="reply in quickReplies" :key="reply.id">
                                    <button 
                                        class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200"
                                        @click="useQuickReply(reply.content)"
                                        x-text="reply.text"
                                    ></button>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
                
                <template x-if="!selectedChat">
                    <div class="h-full flex items-center justify-center text-gray-500">
                        <div class="text-center">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            <p class="text-lg">选择左侧会话开始对话</p>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- 生成工单模态框 -->
    <div x-show="showCreateTaskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">生成工单</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">房间号</label>
                    <input 
                        type="text" 
                        class="w-full p-2 border border-gray-300 rounded-lg"
                        :value="selectedChat?.roomNumber"
                        readonly
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">工单标题</label>
                    <input 
                        type="text" 
                        class="w-full p-2 border border-gray-300 rounded-lg"
                        x-model="taskForm.title"
                        placeholder="AI自动生成或手动输入"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">分配部门</label>
                    <select class="w-full p-2 border border-gray-300 rounded-lg" x-model="taskForm.department">
                        <option value="">请选择</option>
                        <option value="housekeeping">客房部</option>
                        <option value="maintenance">维修部</option>
                        <option value="food">餐饮部</option>
                        <option value="concierge">礼宾部</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">优先级</label>
                    <select class="w-full p-2 border border-gray-300 rounded-lg" x-model="taskForm.priority">
                        <option value="low">低</option>
                        <option value="medium">中</option>
                        <option value="high">高</option>
                        <option value="urgent">紧急</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">描述</label>
                    <textarea 
                        class="w-full p-2 border border-gray-300 rounded-lg"
                        rows="3"
                        x-model="taskForm.description"
                        placeholder="AI根据对话内容自动生成"
                    ></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button 
                    class="px-4 py-2 text-gray-600 hover:text-gray-800"
                    @click="showCreateTaskModal = false"
                >
                    取消
                </button>
                <button 
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                    @click="createTask"
                    data-testid="confirm-create-task"
                >
                    创建工单
                </button>
            </div>
        </div>
    </div>

    <!-- 客人信息模态框 -->
    <div x-show="showGuestInfo" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">客人信息</h3>
            <template x-if="selectedChat">
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">姓名:</span>
                        <span x-text="selectedChat.guestName"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">房间号:</span>
                        <span x-text="selectedChat.roomNumber"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">入住时间:</span>
                        <span x-text="selectedChat.checkInDate"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">预计离店:</span>
                        <span x-text="selectedChat.checkOutDate"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">验证状态:</span>
                        <span 
                            :class="selectedChat.verified ? 'text-green-600' : 'text-red-600'"
                            x-text="selectedChat.verified ? '已验证' : '未验证'"
                        ></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">会话状态:</span>
                        <span x-text="selectedChat.statusText"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">语言:</span>
                        <span x-text="selectedChat.language || '中文'"></span>
                    </div>
                </div>
            </template>
            <div class="flex justify-end mt-6">
                <button 
                    class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                    @click="showGuestInfo = false"
                >
                    关闭
                </button>
            </div>
        </div>
    </div>

    <!-- 人工验证模态框 -->
    <div x-show="showVerifyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">人工验证客人身份</h3>
            <template x-if="verifyingChat">
                <div class="space-y-4">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex">
                            <svg class="w-5 h-5 text-yellow-400 mt-0.5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                            <div>
                                <h4 class="text-sm font-medium text-yellow-800">需要人工验证</h4>
                                <p class="text-sm text-yellow-700 mt-1">该客人身份信息验证失败，需要前台人工核实</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700">房间号</label>
                                <p class="text-lg font-semibold" x-text="verifyingChat.roomNumber"></p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">客人姓名</label>
                                <p class="text-lg font-semibold" x-text="verifyingChat.guestName"></p>
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-sm font-medium text-gray-700">最近消息</label>
                            <p class="text-gray-800 bg-gray-50 p-2 rounded" x-text="verifyingChat.lastMessage"></p>
                        </div>
                        
                        <div>
                            <label class="text-sm font-medium text-gray-700">验证备注</label>
                            <textarea 
                                class="w-full p-2 border border-gray-300 rounded-lg mt-1"
                                rows="3"
                                placeholder="请输入验证情况说明..."
                                x-model="verifyNote"
                            ></textarea>
                        </div>
                    </div>
                </div>
            </template>
            
            <div class="flex justify-end space-x-2 mt-6">
                <button 
                    class="px-4 py-2 text-gray-600 hover:text-gray-800"
                    @click="showVerifyModal = false; verifyingChat = null; verifyNote = ''"
                >
                    取消
                </button>
                <button 
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                    @click="rejectVerification"
                    data-testid="reject-verify-btn"
                >
                    拒绝验证
                </button>
                <button 
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                    @click="approveVerification"
                    data-testid="approve-verify-btn"
                >
                    通过验证
                </button>
            </div>
        </div>
    </div>

    <script>
        function agentWorkspace() {
            console.log('Alpine.js agentWorkspace() 函数已初始化');
            return {
                searchQuery: '',
                selectedChat: null,
                newMessage: '',
                showCreateTaskModal: false,
                showGuestInfo: false,
                showVerifyModal: false,
                verifyingChat: null,
                verifyNote: '',
                activeQueue: 'unverified', // 'verified' 或 'unverified' - 默认显示待验证队列
                
                init() {
                    console.log('Alpine.js 组件已初始化');
                    console.log('会话数据:', this.chats);
                    console.log('已验证会话数量:', this.getQueueCount('verified'));
                    console.log('未验证会话数量:', this.getQueueCount('unverified'));
                    
                    // 隐藏加载检查消息
                    const checkEl = document.getElementById('alpine-check');
                    if (checkEl) {
                        checkEl.style.display = 'none';
                    }
                },
                
                stats: {
                    activeChats: 6,
                    resolvedToday: 8
                },
                
                taskForm: {
                    title: '',
                    department: '',
                    priority: 'medium',
                    description: ''
                },
                
                quickReplies: [
                    { id: 1, text: '好的，马上安排', content: '好的，马上安排相关服务人员为您处理，请稍候。' },
                    { id: 2, text: '需要更多信息', content: '为了更好地为您服务，请提供更多详细信息。' },
                    { id: 3, text: '已记录您的需求', content: '已记录您的需求，我们会尽快为您处理。' },
                    { id: 4, text: '感谢您的耐心', content: '感谢您的耐心等待，有任何问题请随时联系我们。' }
                ],
                
                chats: [
                    { 
                        id: 1, 
                        roomNumber: '301', 
                        guestName: '张先生', 
                        lastMessage: '需要加毛巾', 
                        lastTime: '2分钟前', 
                        verified: true,
                        language: '中文',
                        checkInDate: '2024-01-15',
                        checkOutDate: '2024-01-18',
                        statusText: '活跃',
                        messages: [
                            { id: 1, sender: 'guest', content: '你好，我需要加几条毛巾', timestamp: '14:30' },
                            { id: 2, sender: 'agent', content: '好的，我马上为您安排客房部送毛巾过去', timestamp: '14:31' },
                            { id: 3, sender: 'guest', content: '谢谢，大概多久能到？', timestamp: '14:32' },
                            { id: 4, sender: 'agent', content: '大约10-15分钟内就能送到您的房间', timestamp: '14:33' },
                            { id: 5, sender: 'guest', content: '需要加毛巾', timestamp: '14:35' }
                        ]
                    },
                    { 
                        id: 2, 
                        roomNumber: '205', 
                        guestName: '李女士', 
                        lastMessage: '空调不制冷', 
                        lastTime: '5分钟前', 
                        verified: true,
                        language: '中文',
                        checkInDate: '2024-01-14',
                        checkOutDate: '2024-01-17',
                        statusText: '活跃',
                        messages: [
                            { id: 1, sender: 'guest', content: '房间的空调好像不制冷，温度调到最低还是很热', timestamp: '14:20' },
                            { id: 2, sender: 'agent', content: '您好，我立即安排维修人员过去检查空调', timestamp: '14:21' },
                            { id: 3, sender: 'guest', content: '好的，我现在在房间里', timestamp: '14:22' },
                            { id: 4, sender: 'agent', content: '维修师傅大约5分钟内到达，请稍等', timestamp: '14:23' },
                            { id: 5, sender: 'guest', content: '空调不制冷', timestamp: '14:32' }
                        ]
                    },
                    { 
                        id: 3, 
                        roomNumber: '408', 
                        guestName: 'Smith', 
                        lastMessage: 'WiFi问题', 
                        lastTime: '15分钟前', 
                        verified: false,
                        language: '英语',
                        checkInDate: '2024-01-15',
                        checkOutDate: '2024-01-19',
                        statusText: '等待验证',
                        messages: [
                            { id: 1, sender: 'guest', content: 'Hello, I cannot connect to the WiFi', timestamp: '14:10', translation: '你好，我无法连接WiFi' },
                            { id: 2, sender: 'guest', content: 'Can you help me with the WiFi password?', timestamp: '14:12', translation: '你能帮我解决WiFi密码问题吗？' },
                            { id: 3, sender: 'guest', content: 'WiFi问题', timestamp: '14:22' }
                        ]
                    },
                    { 
                        id: 4, 
                        roomNumber: '509', 
                        guestName: 'Johnson', 
                        lastMessage: '电视问题', 
                        lastTime: '8分钟前', 
                        verified: false,
                        language: '英语',
                        checkInDate: '2024-01-16',
                        checkOutDate: '2024-01-20',
                        statusText: '等待验证',
                        messages: [
                            { id: 1, sender: 'guest', content: 'The TV in my room is not working', timestamp: '14:18', translation: '我房间的电视不工作' },
                            { id: 2, sender: 'guest', content: 'I tried changing channels but nothing works', timestamp: '14:20', translation: '我尝试换台但都不行' },
                            { id: 3, sender: 'guest', content: '电视问题', timestamp: '14:29' }
                        ]
                    },
                    { 
                        id: 5, 
                        roomNumber: '312', 
                        guestName: '田中', 
                        lastMessage: '浴室灯光问题', 
                        lastTime: '12分钟前', 
                        verified: false,
                        language: '日语',
                        checkInDate: '2024-01-15',
                        checkOutDate: '2024-01-18',
                        statusText: '等待验证',
                        messages: [
                            { id: 1, sender: 'guest', content: 'バスルームの電気がつかない', timestamp: '14:15', translation: '浴室的灯不亮' },
                            { id: 2, sender: 'guest', content: 'スイッチを押しても反応しません', timestamp: '14:17', translation: '按开关也没反应' },
                            { id: 3, sender: 'guest', content: '浴室灯光问题', timestamp: '14:25' }
                        ]
                    },
                    { 
                        id: 6, 
                        roomNumber: '607', 
                        guestName: '김민수', 
                        lastMessage: '空调问题', 
                        lastTime: '6分钟前', 
                        verified: false,
                        language: '韩语',
                        checkInDate: '2024-01-16',
                        checkOutDate: '2024-01-19',
                        statusText: '等待验证',
                        messages: [
                            { id: 1, sender: 'guest', content: '에어컨이 안 켜져요', timestamp: '14:25', translation: '空调打不开' },
                            { id: 2, sender: 'guest', content: '리모컨을 눌러도 작동하지 않아요', timestamp: '14:27', translation: '按遥控器也不工作' },
                            { id: 3, sender: 'guest', content: '空调问题', timestamp: '14:31' }
                        ]
                    }
                ],
                
                // 获取队列数量
                getQueueCount(queueType) {
                    if (queueType === 'verified') {
                        return this.chats.filter(chat => chat.verified === true).length;
                    } else {
                        return this.chats.filter(chat => chat.verified === false).length;
                    }
                },
                
                selectChat(chat) {
                    this.selectedChat = chat;
                    console.log('选中会话:', chat.roomNumber, chat.guestName);
                },
                
                sendMessage() {
                    if (!this.newMessage.trim() || !this.selectedChat) return;
                    
                    const message = {
                        id: Date.now(),
                        sender: 'agent',
                        content: this.newMessage,
                        timestamp: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
                    };
                    
                    this.selectedChat.messages.push(message);
                    this.selectedChat.lastMessage = this.newMessage;
                    this.selectedChat.lastTime = '刚刚';
                    this.newMessage = '';
                    
                    this.$nextTick(() => {
                        const container = document.getElementById('messages-container');
                        if (container) {
                            container.scrollTop = container.scrollHeight;
                        }
                    });
                    
                    console.log('调用Chatwoot API发送消息:', {
                        conversation_id: this.selectedChat.id,
                        message: message.content
                    });
                },

                useQuickReply(content) {
                    this.newMessage = content;
                    this.sendMessage();
                },
                
                createTask() {
                    if (!this.taskForm.title || !this.taskForm.department) {
                        alert('请填写标题和部门');
                        return;
                    }
                    
                    const task = {
                        id: Date.now(),
                        title: this.taskForm.title,
                        department: this.taskForm.department,
                        priority: this.taskForm.priority,
                        description: this.taskForm.description,
                        roomNumber: this.selectedChat.roomNumber,
                        guestName: this.selectedChat.guestName,
                        conversationId: this.selectedChat.id,
                        createdAt: new Date().toISOString()
                    };
                    
                    console.log('调用Kanboard API创建工单:', task);
                    
                    console.log('触发Node-RED流程:', {
                        event: 'task_created',
                        data: task
                    });
                    
                    alert('工单创建成功！');
                    
                    this.taskForm = {
                        title: '',
                        department: '',
                        priority: 'medium',
                        description: ''
                    };
                    
                    this.showCreateTaskModal = false;
                },
                
                transferChat() {
                    if (!this.selectedChat) return;
                    const agent = prompt('转接给哪位客服？');
                    if (agent) {
                        console.log('调用Chatwoot API转接会话:', this.selectedChat.id);
                        alert(`已将会话转接给 ${agent}`);
                    }
                },
                
                resolveChat() {
                    if (!this.selectedChat) return;
                    if (confirm('确定要解决这个会话吗？')) {
                        this.selectedChat.status = 'resolved';
                        this.selectedChat.statusText = '已解决';
                        this.stats.resolvedToday++;
                        console.log('调用Chatwoot API解决会话:', this.selectedChat.id);
                        alert('会话已标记为解决');
                    }
                },
                
                // 通过人工验证
                approveVerification() {
                    if (!this.verifyingChat) return;
                    
                    console.log('调用Node-RED API通过验证:', {
                        chatId: this.verifyingChat.id,
                        roomNumber: this.verifyingChat.roomNumber,
                        guestName: this.verifyingChat.guestName,
                        note: this.verifyNote,
                        action: 'approve'
                    });
                    
                    this.verifyingChat.verified = true;
                    this.verifyingChat.status = 'active';
                    this.verifyingChat.statusText = '活跃';
                    
                    alert('验证已通过，客人可以正常使用服务');
                    
                    // 如果当前显示的是该会话，切换到已验证队列
                    const verifyingChatId = this.verifyingChat.id;
                    if (this.selectedChat?.id === verifyingChatId) {
                        this.activeQueue = 'verified';
                    }
                    
                    this.showVerifyModal = false;
                    this.verifyingChat = null;
                    this.verifyNote = '';
                },
                
                // 拒绝验证
                rejectVerification() {
                    if (!this.verifyingChat) return;
                    
                    if (!this.verifyNote.trim()) {
                        alert('请填写拒绝验证的原因');
                        return;
                    }
                    
                    console.log('调用Node-RED API拒绝验证:', {
                        chatId: this.verifyingChat.id,
                        roomNumber: this.verifyingChat.roomNumber,
                        guestName: this.verifyingChat.guestName,
                        note: this.verifyNote,
                        action: 'reject'
                    });
                    
                    // 关闭会话并记录拒绝原因
                    this.verifyingChat.status = 'rejected';
                    this.verifyingChat.statusText = '已拒绝';
                    
                    alert('验证已拒绝，会话将被关闭');
                    
                    // 如果当前显示的是该会话，清空选择
                    const verifyingChatId = this.verifyingChat.id;
                    if (this.selectedChat?.id === verifyingChatId) {
                        this.selectedChat = null;
                    }
                    
                    this.showVerifyModal = false;
                    this.verifyingChat = null;
                    this.verifyNote = '';
                },
                
                // 快速验证
                quickVerify(chat) {
                    if (!chat || chat.verified) return;
                    
                    if (confirm(`确定要验证 ${chat.roomNumber} 房间的 ${chat.guestName} 吗？`)) {
                        console.log('快速验证:', chat.roomNumber, chat.guestName);
                        chat.verified = true;
                        alert(`${chat.roomNumber} 房间客人验证成功！`);
                    }
                }
            }
        }

        // 添加页面加载检查
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM 已加载');
        });

        window.addEventListener('load', function() {
            console.log('页面完全加载');
            
            // 检查Alpine.js是否加载
            setTimeout(() => {
                if (window.Alpine) {
                    console.log('Alpine.js 已加载成功');
                } else {
                    console.error('Alpine.js 未能正确加载');
                }
            }, 1000);
        });
    </script>
</body>
</html> 